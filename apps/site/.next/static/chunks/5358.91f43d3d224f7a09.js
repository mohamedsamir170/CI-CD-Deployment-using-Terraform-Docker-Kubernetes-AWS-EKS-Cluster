"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5358],{75358:(e,t,r)=>{r.d(t,{a:()=>ea,b:()=>eF,c:()=>eG,d:()=>eq,e:()=>eY,f:()=>eW,g:()=>ez});var s=r(67073),n=r(40459);Date.now().toString().slice(5);var a=BigInt(1e3),i=BigInt(1e6),o=BigInt(1e9);function l(e,t){if(t.length<65535)Array.prototype.push.apply(e,t);else{let r=t.length;for(let s=0;s<r;s+=65535)Array.prototype.push.apply(e,t.slice(s,s+65535))}}function h(e,...t){return e.replace(/%(?:(?<position>\d+)\$)?(?<width>-?\d*\.?\d*)(?<type>[dfs])/g,function(...e){let{width:r,type:s,position:n}=e[e.length-1],a=n?t[Number.parseInt(n)-1]:t.shift(),i=""===r?0:Number.parseInt(r);switch(s){case"d":return a.toString().padStart(i,"0");case"f":{let e=a,[t,s]=r.split(".").map(e=>Number.parseFloat(e));return"number"==typeof s&&s>=0&&(e=e.toFixed(s)),"number"==typeof t&&t>=0?e.toString().padStart(i,"0"):e.toString()}case"s":return i<0?a.toString().padEnd(-i," "):a.toString().padStart(i," ");default:return a}})}function c(){return"u">typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}function u(){return"u">typeof n&&n.release&&"node"===n.release.name}function d(){return BigInt(Math.floor(1e6*performance.now()))}function f(e){return"number"==typeof e&&(e=BigInt(e)),e<a?`${e}ns`:e<i?`${e/a}\u03BCs`:e<o?`${e/i}ms`:`${e/o}s`}function p(){return c()?d():u()||"u">typeof n&&"function"==typeof n?.hrtime?.bigint?n.hrtime.bigint():"u">typeof performance?d():BigInt(0)}function g(e,t){return t[1]===e[1]?e[0]-t[0]:t[1]-e[1]}function m(e){if(0===e.length)return[];if(1===e.length)return e[0];for(let t=1;t<e.length;t++)if(e[t].length<e[0].length){let r=e[0];e[0]=e[t],e[t]=r}let t=new Map;for(let r of e[0])t.set(r,1);for(let r=1;r<e.length;r++){let s=0;for(let n of e[r]){let e=t.get(n);e===r&&(t.set(n,e+1),s++)}if(0===s)return[]}return e[0].filter(r=>{let s=t.get(r);return void 0!==s&&t.set(r,0),s===e.length})}function y(e,t){let r={},s=t.length;for(let n=0;n<s;n++){let s=t[n],a=s.split("."),i=e,o=a.length;for(let e=0;e<o;e++)if("object"==typeof(i=i[a[e]])){if(null!==i&&"lat"in i&&"lon"in i&&"number"==typeof i.lat&&"number"==typeof i.lon){i=r[s]=i;break}if(!Array.isArray(i)&&null!==i&&e===o-1){i=void 0;break}}else if((null===i||"object"!=typeof i)&&e<o-1){i=void 0;break}"u">typeof i&&(r[s]=i)}return r}function S(e,t){return y(e,[t])[t]}function b(e,t){e.hits=e.hits.map(e=>({...e,document:{...e.document,...t.reduce((e,t)=>{let r=t.split("."),s=r.pop(),n=e;for(let e of r)n[e]=n[e]??{},n=n[e];return n[s]=null,e},e.document)}}))}function I(e){return e?.constructor?.name==="AsyncFunction"}(0,s.a)(l,"safeArrayPush"),(0,s.a)(h,"sprintf"),(0,s.a)(c,"isInsideWebWorker"),(0,s.a)(u,"isInsideNode"),(0,s.a)(d,"getNanosecondTimeViaPerformance"),(0,s.a)(f,"formatNanoseconds"),(0,s.a)(p,"getNanosecondsTime"),(0,s.a)(g,"sortTokenScorePredicate"),(0,s.a)(m,"intersect"),(0,s.a)(y,"getDocumentProperties"),(0,s.a)(S,"getNested"),(0,s.a)(b,"removeVectorsFromHits"),(0,s.a)(I,"isAsyncFunction");var w=["arabic","armenian","bulgarian","danish","dutch","english","finnish","french","german","greek","hungarian","indian","indonesian","irish","italian","lithuanian","nepali","norwegian","portuguese","romanian","russian","serbian","slovenian","spanish","swedish","tamil","turkish","ukrainian","sanskrit"].join(`
 - `),v={NO_LANGUAGE_WITH_CUSTOM_TOKENIZER:"Do not pass the language option to create when using a custom tokenizer.",LANGUAGE_NOT_SUPPORTED:`Language "%s" is not supported.
Supported languages are:
 - ${w}`,INVALID_STEMMER_FUNCTION_TYPE:"config.stemmer property must be a function.",MISSING_STEMMER:'As of version 1.0.0 @orama/orama does not ship non English stemmers by default. To solve this, please explicitly import and specify the "%s" stemmer from the package @orama/stemmers. See https://docs.oramasearch.com/open-source/text-analysis/stemming for more information.',CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY:"Custom stop words array must only contain strings.",UNSUPPORTED_COMPONENT:'Unsupported component "%s".',COMPONENT_MUST_BE_FUNCTION:'The component "%s" must be a function.',COMPONENT_MUST_BE_FUNCTION_OR_ARRAY_FUNCTIONS:'The component "%s" must be a function or an array of functions.',INVALID_SCHEMA_TYPE:'Unsupported schema type "%s" at "%s". Expected "string", "boolean" or "number" or array of them.',DOCUMENT_ID_MUST_BE_STRING:'Document id must be of type "string". Got "%s" instead.',DOCUMENT_ALREADY_EXISTS:'A document with id "%s" already exists.',DOCUMENT_DOES_NOT_EXIST:'A document with id "%s" does not exists.',MISSING_DOCUMENT_PROPERTY:'Missing searchable property "%s".',INVALID_DOCUMENT_PROPERTY:'Invalid document property "%s": expected "%s", got "%s"',UNKNOWN_INDEX:'Invalid property name "%s". Expected a wildcard string ("*") or array containing one of the following properties: %s',INVALID_BOOST_VALUE:"Boost value must be a number greater than, or less than 0.",INVALID_FILTER_OPERATION:"You can only use one operation per filter, you requested %d.",SCHEMA_VALIDATION_FAILURE:'Cannot insert document due schema validation failure on "%s" property.',INVALID_SORT_SCHEMA_TYPE:'Unsupported sort schema type "%s" at "%s". Expected "string" or "number".',CANNOT_SORT_BY_ARRAY:'Cannot configure sort for "%s" because it is an array (%s).',UNABLE_TO_SORT_ON_UNKNOWN_FIELD:'Unable to sort on unknown field "%s". Allowed fields: %s',SORT_DISABLED:"Sort is disabled. Please read the documentation at https://docs.oramasearch for more information.",UNKNOWN_GROUP_BY_PROPERTY:'Unknown groupBy property "%s".',INVALID_GROUP_BY_PROPERTY:'Invalid groupBy property "%s". Allowed types: "%s", but given "%s".',UNKNOWN_FILTER_PROPERTY:'Unknown filter property "%s".',INVALID_VECTOR_SIZE:'Vector size must be a number greater than 0. Got "%s" instead.',INVALID_VECTOR_VALUE:'Vector value must be a number greater than 0. Got "%s" instead.',INVALID_INPUT_VECTOR:`Property "%s" was declared as a %s-dimensional vector, but got a %s-dimensional vector instead.
Input vectors must be of the size declared in the schema, as calculating similarity between vectors of different sizes can lead to unexpected results.`,WRONG_SEARCH_PROPERTY_TYPE:'Property "%s" is not searchable. Only "string" properties are searchable.',FACET_NOT_SUPPORTED:'Facet doens\'t support the type "%s".',INVALID_DISTANCE_SUFFIX:'Invalid distance suffix "%s". Valid suffixes are: cm, m, km, mi, yd, ft.',INVALID_SEARCH_MODE:'Invalid search mode "%s". Valid modes are: "fulltext", "vector", "hybrid".',MISSING_VECTOR_AND_SECURE_PROXY:"No vector was provided and no secure proxy was configured. Please provide a vector or configure an Orama Secure Proxy to perform hybrid search.",MISSING_TERM:'"term" is a required parameter when performing hybrid search. Please provide a search term.',INVALID_VECTOR_INPUT:'Invalid "vector" property. Expected an object with "value" and "property" properties, but got "%s" instead.',PLUGIN_CRASHED:"A plugin crashed during initialization. Please check the error message for more information:",PLUGIN_SECURE_PROXY_NOT_FOUND:`Could not find '@orama/secure-proxy-plugin' installed in your Orama instance.
Please install it before proceeding with creating an answer session.
Read more at https://docs.orama.com/open-source/plugins/plugin-secure-proxy
`,PLUGIN_SECURE_PROXY_MISSING_CHAT_MODEL:`Could not find a chat model defined in the secure proxy plugin configuration.
Please provide a chat model before proceeding with creating an answer session.
Read more at https://docs.orama.com/open-source/plugins/plugin-secure-proxy
`,ANSWER_SESSION_LAST_MESSAGE_IS_NOT_ASSISTANT:"The last message in the session is not an assistant message. Cannot regenerate non-assistant messages.",PLUGIN_COMPONENT_CONFLICT:'The component "%s" is already defined. The plugin "%s" is trying to redefine it.'};function _(e,...t){let r=Error(h(v[e]??`Unsupported Orama Error code: ${e}`,...t));return r.code=e,"captureStackTrace"in Error.prototype&&Error.captureStackTrace(r),r}function T(e,t){if("string"==typeof t){let r=e.idToInternalId.get(t);if(r)return r;let s=e.idToInternalId.size+1;return e.idToInternalId.set(t,s),e.internalIdToId.push(t),s}return t>e.internalIdToId.length?T(e,t.toString()):t}function x(e,t){if(e.internalIdToId.length<t)throw Error(`Invalid internalId ${t}`);return e.internalIdToId[t-1]}function A(e,t,r,s,n){if(e.some(I))return(async()=>{for(let a of e)await a(t,r,s,n)})();for(let a of e)a(t,r,s,n)}function O(e,t,r,s){if(e.some(I))return(async()=>{for(let n of e)await n(t,r,s)})();for(let n of e)n(t,r,s)}function E(e){return e.documentsStore.count(e.data.docs)}(0,s.a)(_,"createError"),(0,s.a)(T,"getInternalDocumentId"),(0,s.a)(x,"getDocumentIdFromInternalId"),(0,s.a)(A,"runAfterSearch"),(0,s.a)(O,"runBeforeSearch"),(0,s.a)(E,"count");var C="fulltext";function k(e,t){return e[1]-t[1]}function N(e,t){return t[1]-e[1]}function P(e="desc"){return"asc"===e.toLowerCase()?k:N}function L(e,t,r){let s={},n=t.map(([e])=>e),a=e.documentsStore.getMultiple(e.data.docs,n),i=Object.keys(r),o=e.index.getSearchablePropertiesWithTypes(e.data.index);for(let e of i){let t;if("number"===o[e]){let{ranges:s}=r[e],n=s.length,a=Array.from({length:n});for(let e=0;e<n;e++){let t=s[e];a[e]=[`${t.from}-${t.to}`,0]}t=Object.fromEntries(a)}s[e]={count:0,values:t??{}}}let l=a.length;for(let e=0;e<l;e++){let t=a[e];for(let e of i){let n=e.includes(".")?S(t,e):t[e],a=o[e],i=s[e].values;switch(a){case"number":U(r[e].ranges,i)(n);break;case"number[]":{let t=new Set,s=U(r[e].ranges,i,t);for(let e of n)s(e);break}case"boolean":case"enum":case"string":R(i,a)(n);break;case"boolean[]":case"enum[]":case"string[]":{let e=R(i,"boolean[]"===a?"boolean":"string",new Set);for(let t of n)e(t);break}default:throw _("FACET_NOT_SUPPORTED",a)}}}for(let e of i){let t=s[e];if(t.count=Object.keys(t.values).length,"string"===o[e]){let s=r[e],n=P(s.sort);t.values=Object.fromEntries(Object.entries(t.values).sort(n).slice(s.offset??0,s.limit??10))}}return s}function U(e,t,r){return s=>{for(let n of e){let e=`${n.from}-${n.to}`;r?.has(e)||s>=n.from&&s<=n.to&&(void 0===t[e]?t[e]=1:(t[e]++,r?.add(e)))}}}function R(e,t,r){let s="boolean"===t?"false":"";return t=>{let n=t?.toString()??s;r?.has(n)||(e[n]=(e[n]??0)+1,r?.add(n))}}(0,s.a)(k,"sortAsc"),(0,s.a)(N,"sortDesc"),(0,s.a)(P,"sortingPredicateBuilder"),(0,s.a)(L,"getFacets"),(0,s.a)(U,"calculateNumberFacetBuilder"),(0,s.a)(R,"calculateBooleanStringOrEnumFacetBuilder");var D={reducer:(0,s.a)((e,t,r,s)=>(t[s]=r,t),"reducer"),getInitialValue:(0,s.a)(e=>Array.from({length:e}),"getInitialValue")},B=["string","number","boolean"];function M(e,t,r){let s=r.properties,n=s.length,a=e.index.getSearchablePropertiesWithTypes(e.data.index);for(let e=0;e<n;e++){let t=s[e];if(typeof a[t]>"u")throw _("UNKNOWN_GROUP_BY_PROPERTY",t);if(!B.includes(a[t]))throw _("INVALID_GROUP_BY_PROPERTY",t,B.join(", "),a[t])}let i=t.map(([t])=>x(e.internalDocumentIDStore,t)),o=e.documentsStore.getMultiple(e.data.docs,i),l=o.length,h=r.maxResult||Number.MAX_SAFE_INTEGER,c=[],u={};for(let e=0;e<n;e++){let t=s[e],r={property:t,perValue:{}},n=new Set;for(let e=0;e<l;e++){let s=S(o[e],t);if(typeof s>"u")continue;let a="boolean"!=typeof s?s:""+s,i=r.perValue[a]??{indexes:[],count:0};i.count>=h||(i.indexes.push(e),i.count++,r.perValue[a]=i,n.add(s))}c.push(Array.from(n)),u[t]=r}let d=V(c),f=d.length,p=[];for(let e=0;e<f;e++){let t=d[e],r=t.length,n={values:[],indexes:[]},a=[];for(let e=0;e<r;e++){let r=t[e],i=s[e];a.push(u[i].perValue["boolean"!=typeof r?r:""+r].indexes),n.values.push(r)}n.indexes=m(a).sort((e,t)=>e-t),0!==n.indexes.length&&p.push(n)}let g=p.length,y=Array.from({length:g});for(let e=0;e<g;e++){let s=p[e],n=r.reduce||D,a=s.indexes.map(e=>({id:i[e],score:t[e][1],document:o[e]})),l=n.reducer.bind(null,s.values),h=n.getInitialValue(s.indexes.length),c=a.reduce(l,h);y[e]={values:s.values,result:c}}return y}function V(e,t=0){if(t+1===e.length)return e[t].map(e=>[e]);let r=e[t],s=V(e,t+1),n=[];for(let e of r)for(let t of s){let r=[e];l(r,t),n.push(r)}return n}function j(e,t,r){let s,n,{term:a,properties:i}=t,o=e.data.index,l=e.caches.propertiesToSearch;if(!l){let t=e.index.getSearchablePropertiesWithTypes(o);l=(l=e.index.getSearchableProperties(o)).filter(e=>t[e].startsWith("string")),e.caches.propertiesToSearch=l}if(i&&"*"!==i){for(let e of i)if(!l.includes(e))throw _("UNKNOWN_INDEX",e,l.join(", "));l=l.filter(e=>i.includes(e))}if(Object.keys(t.where??{}).length>0&&(s=e.index.searchByWhereClause(o,e.tokenizer,t.where,r)),a||i){let i=E(e);n=e.index.search(o,a||"",e.tokenizer,r,l,t.exact||!1,t.tolerance||0,t.boost||{},F(t.relevance),i,s)}else n=(s?Array.from(s):Object.keys(e.documentsStore.getAll(e.data.docs))).map(e=>[+e,0]);return n}function H(e,t,r){let n=p();function a(){let s,a=Object.keys(e.data.index.vectorIndexes),i=t.facets&&Object.keys(t.facets).length>0,{limit:o=10,offset:l=0,distinctOn:h,includeVectors:c=!1}=t,u=!0===t.preflight,d=j(e,t,r);if(t.sortBy){if("function"==typeof t.sortBy){let r=d.map(([e])=>e),s=e.documentsStore.getMultiple(e.data.docs,r).map((e,t)=>[d[t][0],d[t][1],e]);s.sort(t.sortBy),d=s.map(([e,t])=>[e,t])}else d=e.sorter.sortBy(e.data.sorting,d,t.sortBy).map(([t,r])=>[T(e.internalDocumentIDStore,t),r])}else d=d.sort(g);u||(s=h?et(e,d,l,o,h):er(e,d,l,o));let f={elapsed:{formatted:"",raw:0},hits:[],count:d.length};if("u">typeof s&&(f.hits=s.filter(Boolean),c||b(f,a)),i){let r=L(e,d,t.facets);f.facets=r}return t.groupBy&&(f.groups=M(e,d,t.groupBy)),f.elapsed=e.formatElapsedTime(p()-n),f}async function i(){e.beforeSearch&&await O(e.beforeSearch,e,t,r);let s=a();return e.afterSearch&&await A(e.afterSearch,e,t,r,s),s}return(0,s.a)(a,"performSearchLogic"),(0,s.a)(i,"executeSearchAsync"),e.beforeSearch?.length||e.afterSearch?.length?i():a()}(0,s.a)(M,"getGroups"),(0,s.a)(V,"calculateCombination"),(0,s.a)(j,"innerFullTextSearch"),(0,s.a)(H,"fullTextSearch");var $={k:1.2,b:.75,d:.5};function F(e){let t=e??{};return t.k=t.k??$.k,t.b=t.b??$.b,t.d=t.d??$.d,t}function G(e,t,r){let s=t.vector;if(s&&(!("value"in s)||!("property"in s)))throw _("INVALID_VECTOR_INPUT",Object.keys(s).join(", "));let n=e.data.index.vectorIndexes[s.property],a=n.node.size;if(s?.value.length!==a)throw s?.property===void 0||s?.value.length===void 0?_("INVALID_INPUT_VECTOR","undefined",a,"undefined"):_("INVALID_INPUT_VECTOR",s.property,a,s.value.length);let i=e.data.index,o;return Object.keys(t.where??{}).length>0&&(o=e.index.searchByWhereClause(i,e.tokenizer,t.where,r)),n.node.find(s.value,t.similarity??.8,o)}function q(e,t,r="english"){let n=p();function a(){let s=G(e,t,r).sort(g),a=[];t.facets&&Object.keys(t.facets).length>0&&(a=L(e,s,t.facets));let i=t.vector.property,o=t.includeVectors??!1,l=t.limit??10,h=t.offset??0,c=Array.from({length:l});for(let t=0;t<l;t++){let r=s[t+h];if(!r)break;let n=e.data.docs.docs[r[0]];if(n){o||(n[i]=null);let s={id:x(e.internalDocumentIDStore,r[0]),score:r[1],document:n};c[t]=s}}let u=[];t.groupBy&&(u=M(e,s,t.groupBy));let d=p()-n;return{count:s.length,hits:c.filter(Boolean),elapsed:{raw:Number(d),formatted:f(d)},...a?{facets:a}:{},...u?{groups:u}:{}}}async function i(){e.beforeSearch&&await O(e.beforeSearch,e,t,r);let s=a();return e.afterSearch&&await A(e.afterSearch,e,t,r,s),s}return(0,s.a)(a,"performSearchLogic"),(0,s.a)(i,"executeSearchAsync"),e.beforeSearch?.length||e.afterSearch?.length?i():a()}function Y(e,t,r){let s=X(j(e,t,r)),n=G(e,t,r),a=t.hybridWeights;return Q(s,n,t.term??"",a)}function W(e,t,r){let n=p();function a(){let s,a=Y(e,t,r),i;t.facets&&Object.keys(t.facets).length>0&&(i=L(e,a,t.facets)),t.groupBy&&(s=M(e,a,t.groupBy));let o=er(e,a,t.offset??0,t.limit??10).filter(Boolean),l=p(),h={count:a.length,elapsed:{raw:Number(l-n),formatted:f(l-n)},hits:o,...i?{facets:i}:{},...s?{groups:s}:{}};return t.includeVectors||b(h,Object.keys(e.data.index.vectorIndexes)),h}async function i(){e.beforeSearch&&await O(e.beforeSearch,e,t,r);let s=a();return e.afterSearch&&await A(e.afterSearch,e,t,r,s),s}return(0,s.a)(a,"performSearchLogic"),(0,s.a)(i,"executeSearchAsync"),e.beforeSearch?.length||e.afterSearch?.length?i():a()}function z(e){return e[1]}function X(e){let t=Math.max.apply(Math,e.map(z));return e.map(([e,r])=>[e,r/t])}function K(e,t){return e/t}function J(e,t){return(r,s)=>r*e+s*t}function Q(e,t,r,s){let n=Math.max.apply(Math,e.map(z)),a=Math.max.apply(Math,t.map(z)),{text:i,vector:o}=s&&s.text&&s.vector?s:Z(),l=new Map,h=e.length,c=J(i,o);for(let t=0;t<h;t++){let[r,s]=e[t],a=c(K(s,n),0);l.set(r,a)}let u=t.length;for(let e=0;e<u;e++){let[r,s]=t[e],n=K(s,a),i=l.get(r)??0;l.set(r,i+c(0,n))}return[...l].sort((e,t)=>t[1]-e[1])}function Z(e){return{text:.5,vector:.5}}function ee(e,t,r){let s=t.mode??C;if(s===C)return H(e,t,r);if("vector"===s)return q(e,t);if("hybrid"===s)return W(e,t);throw _("INVALID_SEARCH_MODE",s)}function et(e,t,r,s,n){let a=e.data.docs,i=new Map,o=[],l=new Set,h=t.length,c=0;for(let u=0;u<h;u++){let h=t[u];if(typeof h>"u")continue;let[d,f]=h;if(l.has(d))continue;let p=e.documentsStore.get(a,d),g=S(p,n);if(!(typeof g>"u"||i.has(g))&&(i.set(g,!0),!(++c<=r)&&(o.push({id:x(e.internalDocumentIDStore,d),score:f,document:p}),l.add(d),c>=r+s)))break}return o}function er(e,t,r,s){let n=e.data.docs,a=Array.from({length:s}),i=new Set;for(let o=r;o<s+r;o++){let r=t[o];if(typeof r>"u")break;let[s,l]=r;if(!i.has(s)){let t=e.documentsStore.get(n,s);a[o]={id:x(e.internalDocumentIDStore,s),score:l,document:t},i.add(s)}}return a}(0,s.a)(F,"applyDefault"),(0,s.a)(G,"innerVectorSearch"),(0,s.a)(q,"searchVector"),(0,s.a)(Y,"innerHybridSearch"),(0,s.a)(W,"hybridSearch"),(0,s.a)(z,"extractScore"),(0,s.a)(X,"minMaxScoreNormalization"),(0,s.a)(K,"normalizeScore"),(0,s.a)(J,"hybridScoreBuilder"),(0,s.a)(Q,"mergeAndRankResults"),(0,s.a)(Z,"getQueryWeights"),(0,s.a)(ee,"search"),(0,s.a)(et,"fetchDocumentsWithDistinct"),(0,s.a)(er,"fetchDocuments");var es=class{static{(0,s.a)(this,"AnswerSession")}db;proxy=null;config;abortController=null;lastInteractionParams=null;chatModel=null;conversationID;messages=[];events;initPromise;state=[];constructor(e,t){this.db=e,this.config=t,this.init(),this.messages=t.initialMessages||[],this.events=t.events||{},this.conversationID=t.conversationID||this.generateRandomID()}async ask(e){await this.initPromise;let t="";for await(let r of(await this.askStream(e)))t+=r;return t}async askStream(e){return await this.initPromise,this.fetchAnswer(e)}abortAnswer(){this.abortController?.abort(),this.state[this.state.length-1].aborted=!0,this.triggerStateChange()}getMessages(){return this.messages}clearSession(){this.messages=[],this.state=[]}regenerateLast({stream:e=!0}){if(0===this.state.length||0===this.messages.length)throw Error("No messages to regenerate");if(this.messages.at(-1)?.role!=="assistant")throw _("ANSWER_SESSION_LAST_MESSAGE_IS_NOT_ASSISTANT");return this.messages.pop(),this.state.pop(),e?this.askStream(this.lastInteractionParams):this.ask(this.lastInteractionParams)}async *fetchAnswer(e){if(!this.chatModel)throw _("PLUGIN_SECURE_PROXY_MISSING_CHAT_MODEL");this.abortController=new AbortController,this.lastInteractionParams=e;let t=this.generateRandomID();this.messages.push({role:"user",content:e.term??""}),this.state.push({interactionId:t,aborted:!1,loading:!0,query:e.term??"",response:"",sources:null,translatedQuery:null,error:!1,errorMessage:null});let r=this.state.length-1;this.addEmptyAssistantMessage(),this.triggerStateChange();try{let t=await ee(this.db,e);for await(let e of(this.state[r].sources=t,this.triggerStateChange(),this.proxy.chatStream({model:this.chatModel,messages:this.messages})))yield e,this.state[r].response+=e,this.messages.findLast(e=>"assistant"===e.role).content+=e,this.triggerStateChange()}catch(e){"AbortError"===e.name?this.state[r].aborted=!0:(this.state[r].error=!0,this.state[r].errorMessage=e.toString()),this.triggerStateChange()}return this.state[r].loading=!1,this.triggerStateChange(),this.state[r].response}generateRandomID(e=24){return Array.from({length:e},()=>Math.floor(36*Math.random()).toString(36)).join("")}triggerStateChange(){this.events.onStateChange&&this.events.onStateChange(this.state)}async init(){let e=this;async function t(){return await e.db.plugins.find(e=>"orama-secure-proxy"===e.name)}(0,s.a)(t,"getPlugin");let r=await t();if(!r)throw _("PLUGIN_SECURE_PROXY_NOT_FOUND");let n=r.extra;if(this.proxy=n.proxy,this.config.systemPrompt&&this.messages.push({role:"system",content:this.config.systemPrompt}),n?.pluginParams?.chat?.model)this.chatModel=n.pluginParams.chat.model;else throw _("PLUGIN_SECURE_PROXY_MISSING_CHAT_MODEL")}addEmptyAssistantMessage(){this.messages.push({role:"assistant",content:""})}};function en(e){return e&&"object"==typeof e&&"api_key"in e&&"endpoint"in e}(0,s.a)(en,"isOramaClient");var ea=class{static{(0,s.a)(this,"Switch")}invalidClientError="Invalid client. Expected either an OramaClient or an Orama OSS database.";client;clientType;isCloud=!1;isOSS=!1;constructor(e){if(this.client=e,en(e))this.clientType="cloud",this.isCloud=!0;else if("object"==typeof e&&"id"in e&&"tokenizer"in e)this.clientType="oss",this.isOSS=!0;else throw Error(this.invalidClientError)}async search(e,t){return this.isCloud?this.client.search(e,t):ee(this.client,e)}createAnswerSession(e){if(this.isCloud)return this.client.createAnswerSession(e);if(this.isOSS)return new es(this.client,{conversationID:e.conversationID,initialMessages:e.initialMessages,events:e.events,userContext:e.userContext,systemPrompt:e.systemPrompt});throw Error(this.invalidClientError)}},ei=Object.create,eo=Object.defineProperty,el=Object.getOwnPropertyDescriptor,eh=Object.getOwnPropertyNames,ec=Object.getPrototypeOf,eu=Object.prototype.hasOwnProperty,ed=(0,s.a)((e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),"A"),ef=(0,s.a)((e,t,r,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let a of eh(t))eu.call(e,a)||a===r||eo(e,a,{get:(0,s.a)(()=>t[a],"get"),enumerable:!(n=el(t,a))||n.enumerable});return e},"Dt"),ep=(0,s.a)((e,t,r)=>(r=null!=e?ei(ec(e)):{},ef(!t&&e&&e.__esModule?r:eo(r,"default",{value:e,enumerable:!0}),e)),"Y"),eg=ed(e=>{function t(e){if(!Number.isSafeInteger(e)||e<0)throw Error(`positive integer expected, not ${e}`)}function r(e){if("boolean"!=typeof e)throw Error(`boolean expected, not ${e}`)}function n(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}function a(e,...t){if(!n(e))throw Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function i(e){if("function"!=typeof e||"function"!=typeof e.create)throw Error("Hash should be wrapped by utils.wrapConstructor");t(e.outputLen),t(e.blockLen)}function o(e,t=!0){if(e.destroyed)throw Error("Hash instance has been destroyed");if(t&&e.finished)throw Error("Hash#digest() has already been called")}function l(e,t){a(e);let r=t.outputLen;if(e.length<r)throw Error(`digestInto() expects output buffer of length at least ${r}`)}Object.defineProperty(e,"__esModule",{value:!0}),e.isBytes=n,e.number=t,e.bool=r,e.bytes=a,e.hash=i,e.exists=o,e.output=l,(0,s.a)(t,"R"),(0,s.a)(r,"me"),(0,s.a)(n,"ge"),(0,s.a)(a,"X"),(0,s.a)(i,"ye"),(0,s.a)(o,"Se"),(0,s.a)(l,"be"),e.default={number:t,bool:r,bytes:a,hash:i,exists:o,output:l}}),em=ed(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.add5L=e.add5H=e.add4H=e.add4L=e.add3H=e.add3L=e.rotlBL=e.rotlBH=e.rotlSL=e.rotlSH=e.rotr32L=e.rotr32H=e.rotrBL=e.rotrBH=e.rotrSL=e.rotrSH=e.shrSL=e.shrSH=e.toBig=void 0,e.fromBig=n,e.split=a,e.add=b;var t=BigInt(0x100000000-1),r=BigInt(32);function n(e,s=!1){return s?{h:Number(e&t),l:Number(e>>r&t)}:{h:0|Number(e>>r&t),l:0|Number(e&t)}}function a(e,t=!1){let r=new Uint32Array(e.length),s=new Uint32Array(e.length);for(let a=0;a<e.length;a++){let{h:i,l:o}=n(e[a],t);[r[a],s[a]]=[i,o]}return[r,s]}(0,s.a)(n,"ee"),(0,s.a)(a,"Ie");var i=(0,s.a)((e,t)=>BigInt(e>>>0)<<r|BigInt(t>>>0),"Te");e.toBig=i;var o=(0,s.a)((e,t,r)=>e>>>r,"we");e.shrSH=o;var l=(0,s.a)((e,t,r)=>e<<32-r|t>>>r,"xe");e.shrSL=l;var h=(0,s.a)((e,t,r)=>e>>>r|t<<32-r,"Ae");e.rotrSH=h;var c=(0,s.a)((e,t,r)=>e<<32-r|t>>>r,"Oe");e.rotrSL=c;var u=(0,s.a)((e,t,r)=>e<<64-r|t>>>r-32,"Ee");e.rotrBH=u;var d=(0,s.a)((e,t,r)=>e>>>r-32|t<<64-r,"Pe");e.rotrBL=d;var f=(0,s.a)((e,t)=>t,"ve");e.rotr32H=f;var p=(0,s.a)((e,t)=>e,"Ce");e.rotr32L=p;var g=(0,s.a)((e,t,r)=>e<<r|t>>>32-r,"_e");e.rotlSH=g;var m=(0,s.a)((e,t,r)=>t<<r|e>>>32-r,"Ne");e.rotlSL=m;var y=(0,s.a)((e,t,r)=>t<<r-32|e>>>64-r,"De");e.rotlBH=y;var S=(0,s.a)((e,t,r)=>e<<r-32|t>>>64-r,"ke");function b(e,t,r,s){let n=(t>>>0)+(s>>>0);return{h:e+r+(n/0x100000000|0)|0,l:0|n}}e.rotlBL=S,(0,s.a)(b,"Le");var I=(0,s.a)((e,t,r)=>(e>>>0)+(t>>>0)+(r>>>0),"Re");e.add3L=I;var w=(0,s.a)((e,t,r,s)=>t+r+s+(e/0x100000000|0)|0,"Me");e.add3H=w;var v=(0,s.a)((e,t,r,s)=>(e>>>0)+(t>>>0)+(r>>>0)+(s>>>0),"Be");e.add4L=v;var _=(0,s.a)((e,t,r,s,n)=>t+r+s+n+(e/0x100000000|0)|0,"Ue");e.add4H=_;var T=(0,s.a)((e,t,r,s,n)=>(e>>>0)+(t>>>0)+(r>>>0)+(s>>>0)+(n>>>0),"ze");e.add5L=T;var x=(0,s.a)((e,t,r,s,n,a)=>t+r+s+n+a+(e/0x100000000|0)|0,"He");e.add5H=x,e.default={fromBig:n,split:a,toBig:i,shrSH:o,shrSL:l,rotrSH:h,rotrSL:c,rotrBH:u,rotrBL:d,rotr32H:f,rotr32L:p,rotlSH:g,rotlSL:m,rotlBH:y,rotlBL:S,add:b,add3L:I,add3H:w,add4L:v,add4H:_,add5H:x,add5L:T}}),ey=ed(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.crypto=void 0,e.crypto="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0}),eS=ed(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Hash=e.nextTick=e.byteSwapIfBE=e.byteSwap=e.isLE=e.rotl=e.rotr=e.createView=e.u32=e.u8=void 0,e.isBytes=n,e.byteSwap32=u,e.bytesToHex=f,e.hexToBytes=m,e.asyncLoop=S,e.utf8ToBytes=b,e.toBytes=I,e.concatBytes=w,e.checkOpts=T,e.wrapConstructor=x,e.wrapConstructorWithOpts=A,e.wrapXOFConstructorWithOpts=O,e.randomBytes=E;var t=ey(),r=eg();function n(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}(0,s.a)(n,"Rt");var a=(0,s.a)(e=>new Uint8Array(e.buffer,e.byteOffset,e.byteLength),"Mt");e.u8=a;var i=(0,s.a)(e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4)),"Bt");e.u32=i;var o=(0,s.a)(e=>new DataView(e.buffer,e.byteOffset,e.byteLength),"Ut");e.createView=o;var l=(0,s.a)((e,t)=>e<<32-t|e>>>t,"zt");e.rotr=l;var h=(0,s.a)((e,t)=>e<<t|e>>>32-t>>>0,"Ht");e.rotl=h,e.isLE=68===new Uint8Array(new Uint32Array([0x11223344]).buffer)[0];var c=(0,s.a)(e=>e<<24&0xff000000|e<<8&0xff0000|e>>>8&65280|e>>>24&255,"Ft");function u(t){for(let r=0;r<t.length;r++)t[r]=(0,e.byteSwap)(t[r])}e.byteSwap=c,e.byteSwapIfBE=e.isLE?e=>e:t=>(0,e.byteSwap)(t),(0,s.a)(u,"Wt");var d=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function f(e){(0,r.bytes)(e);let t="";for(let r=0;r<e.length;r++)t+=d[e[r]];return t}(0,s.a)(f,"$t");var p={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function g(e){return e>=p._0&&e<=p._9?e-p._0:e>=p._A&&e<=p._F?e-(p._A-10):e>=p._a&&e<=p._f?e-(p._a-10):void 0}function m(e){if("string"!=typeof e)throw Error("hex string expected, got "+typeof e);let t=e.length,r=t/2;if(t%2)throw Error("padded hex string expected, got unpadded hex of length "+t);let s=new Uint8Array(r);for(let t=0,n=0;t<r;t++,n+=2){let r=g(e.charCodeAt(n)),a=g(e.charCodeAt(n+1));if(void 0===r||void 0===a)throw Error('hex string expected, got non-hex character "'+(e[n]+e[n+1])+'" at index '+n);s[t]=16*r+a}return s}(0,s.a)(g,"Ve"),(0,s.a)(m,"jt");var y=(0,s.a)(async()=>{},"Jt");async function S(t,r,s){let n=Date.now();for(let a=0;a<t;a++){s(a);let t=Date.now()-n;t>=0&&t<r||(await (0,e.nextTick)(),n+=t)}}function b(e){if("string"!=typeof e)throw Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function I(e){return"string"==typeof e&&(e=b(e)),(0,r.bytes)(e),e}function w(...e){let t=0;for(let s=0;s<e.length;s++){let n=e[s];(0,r.bytes)(n),t+=n.length}let s=new Uint8Array(t);for(let t=0,r=0;t<e.length;t++){let n=e[t];s.set(n,r),r+=n.length}return s}e.nextTick=y,(0,s.a)(S,"Kt"),(0,s.a)(b,"$e"),(0,s.a)(I,"U"),(0,s.a)(w,"qt");var v=class{static{(0,s.a)(this,"te")}clone(){return this._cloneInto()}};e.Hash=v;var _={}.toString;function T(e,t){if(void 0!==t&&"[object Object]"!==_.call(t))throw Error("Options should be object or undefined");return Object.assign(e,t)}function x(e){let t=(0,s.a)(t=>e().update(I(t)).digest(),"e"),r=e();return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=()=>e(),t}function A(e){let t=(0,s.a)((t,r)=>e(r).update(I(t)).digest(),"e"),r=e({});return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=t=>e(t),t}function O(e){let t=(0,s.a)((t,r)=>e(r).update(I(t)).digest(),"e"),r=e({});return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=t=>e(t),t}function E(e=32){if(t.crypto&&"function"==typeof t.crypto.getRandomValues)return t.crypto.getRandomValues(new Uint8Array(e));if(t.crypto&&"function"==typeof t.crypto.randomBytes)return t.crypto.randomBytes(e);throw Error("crypto.getRandomValues must be defined")}(0,s.a)(T,"Yt"),(0,s.a)(x,"Xt"),(0,s.a)(A,"Qt"),(0,s.a)(O,"Zt"),(0,s.a)(E,"en")}),eb=ed(e=>{Object.defineProperty(e,"__esModule",{value:!0}),e.shake256=e.shake128=e.keccak_512=e.keccak_384=e.keccak_256=e.keccak_224=e.sha3_512=e.sha3_384=e.sha3_256=e.sha3_224=e.Keccak=void 0,e.keccakP=S;var t=eg(),r=em(),n=eS(),a=[],i=[],o=[],l=BigInt(0),h=BigInt(1),c=BigInt(2),u=BigInt(7),d=BigInt(256),f=BigInt(113);for(let e=0,t=h,r=1,s=0;e<24;e++){[r,s]=[s,(2*r+3*s)%5],a.push(2*(5*s+r)),i.push((e+1)*(e+2)/2%64);let n=l;for(let e=0;e<7;e++)(t=(t<<h^(t>>u)*f)%d)&c&&(n^=h<<(h<<BigInt(e))-h);o.push(n)}var[p,g]=(0,r.split)(o,!0),m=(0,s.a)((e,t,s)=>s>32?(0,r.rotlBH)(e,t,s):(0,r.rotlSH)(e,t,s),"Je"),y=(0,s.a)((e,t,s)=>s>32?(0,r.rotlBL)(e,t,s):(0,r.rotlSL)(e,t,s),"Ke");function S(e,t=24){let r=new Uint32Array(10);for(let s=24-t;s<24;s++){for(let t=0;t<10;t++)r[t]=e[t]^e[t+10]^e[t+20]^e[t+30]^e[t+40];for(let t=0;t<10;t+=2){let s=(t+8)%10,n=(t+2)%10,a=r[n],i=r[n+1],o=m(a,i,1)^r[s],l=y(a,i,1)^r[s+1];for(let r=0;r<50;r+=10)e[t+r]^=o,e[t+r+1]^=l}let t=e[2],n=e[3];for(let r=0;r<24;r++){let s=i[r],o=m(t,n,s),l=y(t,n,s),h=a[r];t=e[h],n=e[h+1],e[h]=o,e[h+1]=l}for(let t=0;t<50;t+=10){for(let s=0;s<10;s++)r[s]=e[t+s];for(let s=0;s<10;s++)e[t+s]^=~r[(s+2)%10]&r[(s+4)%10]}e[0]^=p[s],e[1]^=g[s]}r.fill(0)}(0,s.a)(S,"Xe");var b=class e extends n.Hash{static{(0,s.a)(this,"t")}constructor(e,r,s,a=!1,i=24){if(super(),this.blockLen=e,this.suffix=r,this.outputLen=s,this.enableXOF=a,this.rounds=i,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,t.number)(s),0>=this.blockLen||this.blockLen>=200)throw Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,n.u32)(this.state)}keccak(){n.isLE||(0,n.byteSwap32)(this.state32),S(this.state32,this.rounds),n.isLE||(0,n.byteSwap32)(this.state32),this.posOut=0,this.pos=0}update(e){(0,t.exists)(this);let{blockLen:r,state:s}=this,a=(e=(0,n.toBytes)(e)).length;for(let t=0;t<a;){let n=Math.min(r-this.pos,a-t);for(let r=0;r<n;r++)s[this.pos++]^=e[t++];this.pos===r&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:e,suffix:t,pos:r,blockLen:s}=this;e[r]^=t,128&t&&r===s-1&&this.keccak(),e[s-1]^=128,this.keccak()}writeInto(e){(0,t.exists)(this,!1),(0,t.bytes)(e),this.finish();let r=this.state,{blockLen:s}=this;for(let t=0,n=e.length;t<n;){this.posOut>=s&&this.keccak();let a=Math.min(s-this.posOut,n-t);e.set(r.subarray(this.posOut,this.posOut+a),t),this.posOut+=a,t+=a}return e}xofInto(e){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return(0,t.number)(e),this.xofInto(new Uint8Array(e))}digestInto(e){if((0,t.output)(e,this),this.finished)throw Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(t){let{blockLen:r,suffix:s,outputLen:n,rounds:a,enableXOF:i}=this;return t||(t=new e(r,s,n,i,a)),t.state32.set(this.state32),t.pos=this.pos,t.posOut=this.posOut,t.finished=this.finished,t.rounds=a,t.suffix=s,t.outputLen=n,t.enableXOF=i,t.destroyed=this.destroyed,t}};e.Keccak=b;var I=(0,s.a)((e,t,r)=>(0,n.wrapConstructor)(()=>new b(t,e,r)),"T");e.sha3_224=I(6,144,28),e.sha3_256=I(6,136,32),e.sha3_384=I(6,104,48),e.sha3_512=I(6,72,64),e.keccak_224=I(1,144,28),e.keccak_256=I(1,136,32),e.keccak_384=I(1,104,48),e.keccak_512=I(1,72,64);var w=(0,s.a)((e,t,r)=>(0,n.wrapXOFConstructorWithOpts)((s={})=>new b(t,e,void 0===s.dkLen?r:s.dkLen,!0)),"Qe");e.shake128=w(31,168,16),e.shake256=w(31,136,32)}),eI=ed((e,t)=>{var{sha3_512:r}=eb(),n=24,a=32,i=(0,s.a)((e=4,t=Math.random)=>{let r="";for(;r.length<e;)r+=Math.floor(36*t()).toString(36);return r},"re");function o(e){let t=BigInt(8),r=BigInt(0);for(let s of e.values())r=(r<<t)+BigInt(s);return r}(0,s.a)(o,"nt");var l=(0,s.a)((e="")=>o(r(e)).toString(36).slice(1),"rt"),h=Array.from({length:26},(e,t)=>String.fromCharCode(t+97)),c=(0,s.a)(e=>h[Math.floor(e()*h.length)],"un"),u=(0,s.a)(({globalObj:e="u">typeof global?global:"u">typeof window?window:{},random:t=Math.random}={})=>{let r=Object.keys(e).toString();return l(r.length?r+i(a,t):i(a,t)).substring(0,a)},"st"),d=(0,s.a)(e=>()=>e++,"ot"),f=0x1c6b1f1f,p=(0,s.a)(({random:e=Math.random,counter:t=d(Math.floor(e()*f)),length:r=n,fingerprint:s=u({random:e})}={})=>function(){let n=c(e),a=Date.now().toString(36),o=t().toString(36),h=i(r,e),u=`${a+h+o+s}`;return`${n+l(u).substring(1,r)}`},"it"),g=p(),m=(0,s.a)((e,{minLength:t=2,maxLength:r=a}={})=>{let s=e.length;return!!("string"==typeof e&&s>=t&&s<=r&&/^[a-z][0-9a-z]+$/.test(e))},"fn");t.exports.getConstants=()=>({defaultLength:n,bigLength:a}),t.exports.init=p,t.exports.createId=g,t.exports.bufToBigInt=o,t.exports.createCounter=d,t.exports.createFingerprint=u,t.exports.isCuid=m}),ew=ed((e,t)=>{var{createId:r,init:s,getConstants:n,isCuid:a}=eI();t.exports.createId=r,t.exports.init=s,t.exports.getConstants=n,t.exports.isCuid=a}),ev=ep(ew(),1);Date.now().toString().slice(5);var e_=BigInt(1e3),eT=BigInt(1e6),ex=BigInt(1e9);function eA(e){return"number"==typeof e&&(e=BigInt(e)),e<e_?`${e}ns`:e<eT?`${e/e_}\u03BCs`:e<ex?`${e/eT}ms`:`${e/ex}s`}function eO(e){return{raw:Number(e),formatted:eA(e)}}(0,s.a)(eA,"dt"),["arabic","armenian","bulgarian","danish","dutch","english","finnish","french","german","greek","hungarian","indian","indonesian","irish","italian","lithuanian","nepali","norwegian","portuguese","romanian","russian","serbian","slovenian","spanish","swedish","tamil","turkish","ukrainian","sanskrit"].join(`
 - `),(0,s.a)(eO,"oe");var eE="2.1.4",eC={version:eE},ek=ep(ew(),1),eN="orama_user_id";function eP(e){let[t,...r]=e.split(`
`),s=r.join(`
`).replace("data: ","");return{event:t.replace("event: ",""),data:s}}function eL(e){return"object"==typeof e?JSON.stringify(e):`${e}`}(0,s.a)(eP,"bt"),(0,s.a)(eL,"ae");var eU=class{static{(0,s.a)(this,"H")}messages;inferenceType;oramaClient;endpoint;abortController;events;userContext;conversationID;lastInteractionParams;state=[];systemPrompts;constructor(e){let t=e.oramaClient.answersApiBaseURL||"https://answer.api.orama.com";this.messages=e.initialMessages||[],this.inferenceType=e.inferenceType,this.oramaClient=e.oramaClient,this.endpoint=`${t}/v1/answer?api-key=${this.oramaClient.api_key}`,this.events=e.events,this.conversationID=(0,ek.createId)(),this.userContext=e.userContext}async askStream(e){return this.messages.push({role:"user",content:e.term??""}),this.fetchAnswer(e)}async ask(e){let t=await this.askStream(e),r="";for await(let e of t)r=e;return this.events?.onMessageChange&&this.events.onMessageChange(this.messages),r}getMessages(){return this.messages}clearSession(){this.messages=[],this.state=[],this.events?.onMessageChange&&this.events.onMessageChange(this.messages),this.events?.onStateChange&&this.events.onStateChange(this.state)}abortAnswer(){if(!this.abortController)throw Error("AbortController is not ready");this.abortController.abort(),this.abortController=void 0,this.state[this.state.length-1].aborted=!0}async regenerateLast({stream:e=!0}={}){if(0===this.state.length||0===this.messages.length)throw Error("No messages to regenerate");if(this.messages.at(-1)?.role!=="assistant")throw Error("Last message is not an assistant message");return this.messages.pop(),this.state.pop(),e?this.askStream(this.lastInteractionParams):this.ask(this.lastInteractionParams)}addNewEmptyAssistantMessage(){this.messages.push({role:"assistant",content:""})}async *fetchAnswer(e){this.abortController=new AbortController,this.lastInteractionParams=e;let t=(0,ek.createId)(),r=null,s=this.state.length;this.state.push({interactionId:t,query:e.term??"",response:"",relatedQueries:null,sources:null,translatedQuery:null,segment:null,trigger:null,aborted:!1,loading:!0,error:!1,errorMessage:null});try{this.events?.onNewInteractionStarted&&this.events.onNewInteractionStarted(t),this.events?.onStateChange&&this.events.onStateChange(this.state);let n=new URLSearchParams;n.append("type",this.inferenceType),n.append("messages",JSON.stringify(this.messages)),n.append("query",e.term??""),n.append("conversationId",this.conversationID),n.append("userId",this.oramaClient.getUserId()),n.append("endpoint",this.oramaClient.endpoint),n.append("searchParams",JSON.stringify(e)),n.append("identity",this.oramaClient.getIdentity()??""),n.append("interactionId",t),n.append("alias",this.oramaClient.getAlias()??"");let a=this.getSystemPromptConfiguration();if(a&&n.append("systemPrompts",JSON.stringify(a)),this.userContext&&n.append("userContext",eL(this.userContext)),e.userData&&n.append("userData",eL(e.userData)),e.related){if(e.related?.howMany&&e.related?.howMany>5)throw Error("Can generate at most 5 related queries");n.append("related",JSON.stringify({enabled:!0,howMany:e.related.howMany??3,format:e.related.format??"question"}))}let i=await fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString(),signal:this.abortController.signal});if(!i.ok||!i.body)throw Error(i.statusText);r=i.body.getReader();let o=new TextDecoder,l=[],h="";this.events?.onMessageLoading&&this.events.onMessageLoading(!0),this.addNewEmptyAssistantMessage();let c=this.messages.at(-1);for(;;){let e,{value:t,done:n}=await r.read();if(n)break;for(h+=o.decode(t,{stream:!0});-1!==(e=h.indexOf(`

`));){let t=h.slice(0,e);h=h.slice(e+2);try{let e=eP(t),r=JSON.parse(e.data);if("sources"===r.type)this.state[s].sources=r.message,this.events?.onSourceChange&&this.events.onSourceChange(r.message),this.events?.onStateChange&&this.events.onStateChange(this.state);else if("query-translated"===r.type)this.state[s].translatedQuery=r.message,this.events?.onQueryTranslated&&this.events.onQueryTranslated(r.message),this.events?.onStateChange&&this.events.onStateChange(this.state);else if("conversation-metadata"===r.type){let{segment:e,trigger:t}=r.message;e&&(this.state[s].segment=e),t&&(this.state[s].trigger=t),this.events?.onStateChange&&this.events.onStateChange(this.state)}else if("related-queries"===r.type)this.state[s].relatedQueries=r.message,this.events?.onRelatedQueries&&this.events.onRelatedQueries(r.message),this.events?.onStateChange&&this.events.onStateChange(this.state);else if("text"===r.type)for(l.push(r.message);l.length>0;)c.content+=l.shift(),this.state[s].response=c.content,this.events?.onStateChange&&this.events.onStateChange(this.state),this.events?.onMessageChange&&this.events.onMessageChange(this.messages),yield c.content}catch(e){console.error("Error parsing SSE event:",e),console.error("Raw message:",t)}}}}catch(e){if("AbortError"===e.name)this.state[s].aborted=!0,this.events?.onAnswerAborted&&this.events.onAnswerAborted(!0);else throw this.state[s].error=!0,this.state[s].errorMessage=e.message??"Unknown error",e}finally{r?.releaseLock(),this.state[s].loading=!1,this.events?.onStateChange&&this.events.onStateChange(this.state),this.events?.onInteractionDone&&this.events.onInteractionDone(this.state[s]),this.events?.onMessageLoading&&this.events.onMessageLoading(!1)}}setSystemPromptConfiguration(e){if(Array.isArray(e.systemPrompts)){if(!e.systemPrompts.every(e=>"string"==typeof e))throw Error("Invalid system prompt configuration");this.systemPrompts=e.systemPrompts}return this}getSystemPromptConfiguration(){return this.systemPrompts}},eR=class{static{(0,s.a)(this,"F")}cache;config;constructor(e){this.cache=new Map,this.config=e}set(e,t){this.cache.set(e,t)}get(e){return this.cache.get(e)}has(e){return this.cache.has(e)}delete(e){return this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}};function eD(e,t){if("u">typeof navigator){"u">typeof navigator.sendBeacon&&navigator.sendBeacon(e,t);return}fetch(e,{method:"POST",body:t,headers:{"Content-Type":"application/json"}}).then(()=>{},e=>console.log(e))}(0,s.a)(eD,"O");var eB=class e{static{(0,s.a)(this,"t")}data;params;config;profile;constructor(e,t){this.data=[],this.config=e,this.profile=t}setParams(e){this.params=e}static create(t,r){let s=new e(t,r);return s.start(),s}add(e){this.data.push({rawSearchString:e.rawSearchString,query:e.query,resultsCount:e.resultsCount,roundTripTime:e.roundTripTime,searchedAt:e.searchedAt,userId:this.profile.getUserId(),identity:this.profile.getIdentity(),alias:this.profile.getAlias(),referer:"u">typeof location?location.toString():void 0}),null!=this.params&&this.data.length>=this.config.flushSize&&this.flush()}flush(){if(null==this.params||0===this.data.length)return;let e=this.data;this.data=[];let t={source:"fe",deploymentID:this.params.deploymentID,index:this.params.index,oramaId:this.config.id,oramaVersion:eC.version,userAgent:"u">typeof navigator?navigator.userAgent:void 0,events:e};eD(`${this.params.endpoint}?api-key=${this.config.api_key}`,JSON.stringify(t))?.catch(e=>console.log(e))}start(){let e=setInterval(this.flush.bind(this),this.config.flushInterval);null!=e.unref&&e.unref()}},eM=class{static{(0,s.a)(this,"V")}constructor(e){this.params=e}intervalId;start(){this.stop(),this.intervalId=setInterval(this.beat.bind(this),this.params.frequency)}stop(){void 0!==this.intervalId&&clearInterval(this.intervalId)}beat(){eD(this.params.endpoint)?.catch(e=>console.log(e))}},eV=ep(ew(),1),ej=class{static{(0,s.a)(this,"j")}endpoint;apiKey;userId;identity;userAlias;params;constructor({endpoint:e,apiKey:t}){if(!e||!t)throw Error("Endpoint and API Key are required to create a Profile");if("string"!=typeof e||"string"!=typeof t)throw Error("Endpoint and API Key must be strings");if("u">typeof localStorage){let e=localStorage.getItem(eN);e?this.userId=e:(this.userId=(0,eV.createId)(),localStorage.setItem(eN,this.userId))}else this.userId=(0,eV.createId)();this.endpoint=e,this.apiKey=t}setParams(e){let{protocol:t,host:r}=new URL(e.identifyUrl),s=`${t}//${r}/identify`;this.params={identifyUrl:s,index:e.index}}getIdentity(){return this.identity}getUserId(){return this.userId}getAlias(){return this.userAlias}async sendProfileData(e){if(!this.params)throw Error("Orama Profile is not initialized");let t=JSON.stringify({...e,visitorId:this.getUserId(),index:this.params.index});await eD(`${this.params?.identifyUrl}?api-key=${this.apiKey}`,t)}async identify(e,t){if("string"!=typeof t)throw Error("Identity must be a string");await e,await this.sendProfileData({entity:"identity",id:t}),this.identity=t}async alias(e,t){if("string"!=typeof t)throw Error("Identity must be a string");await e,await this.sendProfileData({entity:"alias",id:t}),this.userAlias=t}reset(){this.userId=(0,eV.createId)(),this.identity=void 0,this.userAlias=void 0}};function eH(e){return void 0!==e&&e?.signal!==void 0}(0,s.a)(eH,"vn");var e$=class{static{(0,s.a)(this,"It")}id=(0,ev.createId)();api_key;endpoint;multiIndexSearch;mergeResults;multiIndexIndexes;answersApiBaseURL;collector;cache;profile;searchDebounceTimer;searchRequestCounter=0;blockSearchTillAuth=!1;heartbeat;initPromise;constructor(e){if("indexes"in e){this.api_key=e.indexes[0].api_key,this.multiIndexIndexes=e.indexes;let t=new URL(e.indexes[0].endpoint).origin;if(e.indexes.some(e=>new URL(e.endpoint).origin!==t))throw Error("All indexes must have the same endpoint origin");this.endpoint=t+"/v1/indexes",this.multiIndexSearch=!0,this.mergeResults=e.mergeResults??!0}else this.api_key=e.api_key,this.endpoint=e.endpoint,this.multiIndexSearch=!1,this.mergeResults=!0;if(this.answersApiBaseURL=e.answersApiBaseURL,this.profile=new ej({endpoint:this.endpoint,apiKey:this.api_key}),!1!==e.telemetry){let t={id:this.id,api_key:this.api_key,flushInterval:e.telemetry?.flushInterval??5e3,flushSize:e.telemetry?.flushSize??25};this.collector=eB.create(t,this.profile)}!1!==e.cache&&(this.cache=new eR({})),this.init()}customerUserToken=void 0;searchToken=void 0;setAuthToken(e){null===e?this.customerUserToken=void 0:this.customerUserToken=e,this.searchToken=void 0,this.init()}onAuthTokenExpired;setOnAuthTokenExpired(e){this.onAuthTokenExpired=e}addSearchResultsToCollector(e,t,r,s){if(this.collector){if(Array.isArray(e))for(let n of e)this.collector.add({rawSearchString:r.term,resultsCount:n.hits?.length??0,roundTripTime:t,query:r,cached:s,searchedAt:new Date,userId:this.profile.getUserId()});else this.collector.add({rawSearchString:r.term,resultsCount:e?.hits?.length??0,roundTripTime:t,query:r,cached:s,searchedAt:new Date,userId:this.profile.getUserId()})}}async search(e,t){if(await this.initPromise,this.blockSearchTillAuth)return console.warn("Search request blocked until user is authenticated"),null;let r=++this.searchRequestCounter,n=`search-${JSON.stringify(e)}`,a=null,i,o=!1,l=t?.fresh!==!0&&this.cache?.has(n),h=(0,s.a)(async()=>{try{let r=Date.now();a=this.multiIndexSearch?await this.fetch("multi_search","POST",{q:{...e,mergeResults:this.mergeResults},sst:this.searchToken,indexes:this.multiIndexIndexes},t?.abortController):await this.fetch("search","POST",{q:e,sst:this.searchToken},t?.abortController);let s=Date.now();i=s-r;let o=await eO(BigInt(1e6*s-1e6*r));if(Array.isArray(a))for(let e of a)e.elapsed=o;else a.elapsed=o;this.cache?.set(n,a)}catch(e){if("AbortError"!==e.name)throw console.error("Search request failed",e),e}return this.addSearchResultsToCollector(a,i,e,o),a},"h");return l&&this.cache?(i=0,a=this.cache.get(n),o=!0,this.addSearchResultsToCollector(a,i,e,o),r===this.searchRequestCounter?a:null):t?.debounce?new Promise((e,r)=>{clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=setTimeout(async()=>{try{await h(),e(a)}catch(e){"AbortError"!==e.name&&(console.error("Search request failed",e),r(e))}},t?.debounce||300),"unref"in this.searchDebounceTimer&&this.searchDebounceTimer.unref()}):h()}async vectorSearch(e,t){await this.initPromise;let r=`vectorSearch-${JSON.stringify(e)}`,s,n,a=!1;if((t?.fresh!==!0&&this.cache?.has(r))===!0&&null!=this.cache)s=0,n=this.cache.get(r),a=!0;else{let a=Date.now();n=await this.fetch("vector-search2","POST",{q:e},t?.abortSignal??t?.abortController);let i=Date.now();n.elapsed=await eO(BigInt(1e6*i-1e6*a)),s=i-a,this.cache?.set(r,n)}return null!=this.collector&&this.collector.add({rawSearchString:e.term,resultsCount:n.hits?.length??0,roundTripTime:s,query:e,cached:a,searchedAt:new Date,userId:this.profile.getUserId()}),n}createAnswerSession(e){return new eU({inferenceType:e?.inferenceType||"documentation",initialMessages:e?.initialMessages||[],oramaClient:this,events:e?.events,userContext:e?.userContext,systemPrompts:e?.systemPrompts??[]})}startHeartBeat(e){this.heartbeat?.stop(),this.heartbeat=new eM({...e,endpoint:`${this.endpoint}/health?api-key=${this.api_key}`}),this.heartbeat.start()}stopHeartBeat(){this.heartbeat?.stop()}async getPop(){return(await this.initPromise)?.pop??""}expirationTimer;init(){let e=["init","GET",void 0,void 0,{token:this.customerUserToken}];this.multiIndexSearch&&(e=["init_multi_search","POST",{indexes:this.multiIndexIndexes},void 0,{token:this.customerUserToken}]),this.initPromise=this.fetch(...e).then(e=>{if(this.collector?.setParams({endpoint:e.collectUrl,deploymentID:e.deploymentID,index:e.index}),this.profile?.setParams({identifyUrl:e.collectUrl,index:e.index}),e.searchSession){if("required"in e.searchSession&&!0===e.searchSession.required)this.blockSearchTillAuth=!0;else if("token"in e.searchSession){let t=e.searchSession.token;this.searchToken=t;let r=e.searchSession.maxAge;this.blockSearchTillAuth=!1,this.expirationTimer&&clearTimeout(this.expirationTimer),this.expirationTimer=setTimeout(()=>{this.searchToken===t&&(this.searchToken=void 0,this.blockSearchTillAuth=!0,this.onAuthTokenExpired?.(t))},1e3*r),"unref"in this.expirationTimer&&this.expirationTimer.unref()}}return e}).catch(e=>(console.log(e),null))}async fetch(e,t,r,s,n){let a=eH(s)?s?.signal:s;if(a?.aborted===!0)throw Error("Request aborted");let i={method:t,headers:{"Content-Type":"application/x-www-form-urlencoded"},signal:a};"POST"===t&&void 0!==r&&(r.version=eE,r.id=this.id,r.visitorId=this.profile.getUserId(),i.body=Object.entries(r).filter(([e,t])=>!!t).map(([e,t])=>`${e}=${encodeURIComponent(JSON.stringify(t))}`).join("&"));let o=new URL(`${this.endpoint}/${e}`);if(this.multiIndexSearch||o.searchParams.append("api-key",this.api_key),n)for(let[e,t]of Object.entries(n))t&&o.searchParams.append(e,t);let l=await fetch(o,i);if(!l.ok){let e=Error();throw e.httpResponse=l,e}return await l.json()}getIdentity(){return this.profile.getIdentity()}getUserId(){return this.profile.getUserId()}getAlias(){return this.profile.getAlias()}async identify(e){if(void 0===this.initPromise)throw Error("OramaClient not initialized");await this.profile.identify(this.initPromise,e)}async alias(e){if(void 0===this.initPromise)throw Error("OramaClient not initialized");await this.profile.alias(this.initPromise,e)}reset(){this.profile.reset()}};function eF(e,t,r="[focus-on-arrow-nav]"){if("ArrowDown"!==t.key&&"ArrowUp"!==t.key)return;t.stopPropagation(),t.preventDefault();let s=Array.from(e.querySelectorAll(r)),n=(s=s.filter(e=>-1!==e.tabIndex))[0],a=s[s.length-1],i=e.querySelector(":focus"),o=s.indexOf(i),l;"ArrowDown"===t.key?(l=o===s.length-1?n:s[o+1],l?.focus()):"ArrowUp"===t.key&&(l=0===o?a:s[o-1],l?.focus())}function eG(e){var t;if(!(null===(t=navigator.clipboard)||void 0===t)&&t.writeText)navigator.clipboard.writeText(e).catch(e=>{console.error("Could not copy text: ",e)});else{let t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}function eq(e,t){return Array.from(e.attributes).reduce((e,r)=>(t.includes(r.name)||(e[r.name]=r.value),e),{})}function eY(e,t,r){let s=`
    Component: ${e.tagName.toLowerCase()}
    Id: ${e.id}
  `;if(!t&&!r)throw Error(`Invalid component configuration. Please provide a valid index or instance prop. ${s}`);if(r&&!t&&new ea(r).search({term:"test"}).catch(()=>{throw Error(`Invalid cloud instance configuration. Please provide a valid api_key and endpoint ${s}`)}),t&&!r){if(!t.api_key||!t.endpoint)throw Error(`Invalid cloud index configuration. Please provide a valid api_key and endpoint ${s}`);return}t&&r&&console.warn(`Both index and instance props are provided. Instance prop will be used. ${s}`)}function eW(e){return new e$({api_key:e.api_key,endpoint:e.endpoint})}function ez(e){return`orama-ui-${e}-${Math.random().toString(36).substring(2,15)}`}(0,s.a)(eF,"arrowKeysNavigation"),(0,s.a)(eG,"copyToClipboard"),(0,s.a)(eq,"getNonExplicitAttributes"),(0,s.a)(eY,"validateCloudIndexConfig"),(0,s.a)(eW,"initOramaClient"),(0,s.a)(ez,"generateRandomID")}}]);