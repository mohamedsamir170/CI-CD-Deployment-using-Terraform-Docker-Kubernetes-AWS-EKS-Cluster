name: Blue-Green Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

env:
  KUBECONFIG: ${{ secrets.KUBECONFIG }}
  HELM_RELEASE_NAME: nodejs-app
  HELM_CHART_PATH: ./nodejs-helm

jobs:
  # build-and-test:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Set up Node.js
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: '22'

  #     - name: Install dependencies
  #       run: npm install

  #     - name: Run tests
  #       run: npm run test

  #     - name: Build the application
  #       run: npm run build

  # build-and-push:
  #   runs-on: ubuntu-latest
  #   needs: build-and-test

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Log in to Docker Hub
  #       run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

  #     - name: Build Docker image
  #       run: |
  #         docker build -t ${{ secrets.DOCKER_USERNAME }}/nodejs:latest .

  #     - name: Push Docker image
  #       run: |
  #         docker push ${{ secrets.DOCKER_USERNAME }}/nodejs:latest

  deploy:
    runs-on: ubuntu-latest
    # needs: build-and-push
    steps:
      # Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: aws eks --region ${{ secrets.AWS_REGION }} update-kubeconfig --name ${{ secrets.PRODUCTION_CLUSTER }}

      - name: Choose Deployment Target
        id: choose-target
        run: |
          echo "Select deployment target:"
          echo "1) blue"
          echo "2) green"
          read -p "Enter the number corresponding to your choice: " CHOICE
          if [ "$CHOICE" == "1" ]; then
            echo "target=blue" >> $GITHUB_ENV
          elif [ "$CHOICE" == "2" ]; then
            echo "target=green" >> $GITHUB_ENV
          else
            echo "Invalid choice, exiting."
            exit 1
          fi

      - name: Deploy to Kubernetes
        run: |
          if [ "${{ env.target }}" == "blue" ]; then
            echo "Deploying to blue..."
            kubectl apply -f ./deployment-blue.yaml
          elif [ "${{ env.target }}" == "green" ]; then
            echo "Deploying to green..."
            kubectl apply -f ./deployment-green.yaml
          else
            echo "Invalid target environment, exiting."
            exit 1
          fi
